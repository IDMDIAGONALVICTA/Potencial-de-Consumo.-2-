<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>An√°lise de Potencial de Mercado Imobili√°rio - Vers√£o Corrigida</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #00512A 0%, #007C27 100%); padding: 20px; min-height: 100vh; }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 20px; padding: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        h1 { color: #00512A; margin-bottom: 10px; font-size: 2.5em; }
        .subtitle { color: #00512A; margin-bottom: 30px; font-size: 1.1em; }
        .input-group { display: flex; gap: 10px; margin-bottom: 20px; }
        input[type="text"] { flex: 1; padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; }
        input[type="text"]:focus { outline: none; border-color: #00512A; }
        button { padding: 15px 30px; background: linear-gradient(135deg, #00512A 0%, #007C27 100%); color: white; border: none; border-radius: 10px; font-size: 16px; cursor: pointer; transition: transform 0.2s; }
        button:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4); }
        .map-container { margin-bottom: 30px; }
        #map { width: 100%; height: 500px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .demographics-section { background: linear-gradient(135deg, #F0F5CD 0%, #F0F5CD 100%); padding: 25px; border-radius: 15px; margin-bottom: 30px; }
        .demographics-section h3 { color: #00512A; margin-bottom: 20px; font-size: 1.4em; display: flex; align-items: center; gap: 10px; }
        .demographics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; }
        .demo-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 3px 10px rgba(0,0,0,0.1); transition: transform 0.2s; }
        .demo-card:hover { transform: translateY(-3px); box-shadow: 0 5px 20px rgba(0,0,0,0.15); }
        .demo-card h4 { color: #00512A; margin-bottom: 10px; font-size: 0.9em; display: flex; align-items: center; gap: 8px; }
        .demo-card p { color: #333; font-size: 1.8em; font-weight: bold; margin: 5px 0; }
        .demo-card small { color: #00512A; font-size: 0.9em; }
        .analysis-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .analysis-card { background: linear-gradient(135deg, #F0F5CD 0%, #F0F5CD 100%); padding: 25px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); min-height: 400px; }
        .analysis-card h3 { color: #00512A; margin-bottom: 20px; font-size: 1.3em; }
        .chart-container { position: relative; height: 320px; }
        .insights-section { background: linear-gradient(135deg, #00512A 0%, #007C27 100%); color: white; padding: 30px; border-radius: 15px; margin-top: 20px; }
        .insights-section h3 { margin-bottom: 20px; font-size: 1.5em; }
        .insight-box { background: rgba(255,255,255,0.15); padding: 20px; border-radius: 10px; margin-bottom: 15px; }
        .insight-box h4 { margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        .icon { font-size: 1.5em; }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            margin-bottom: 30px;
            font-size: 1em;
            text-align: center;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .data-table th, .data-table td {
            padding: 16px 20px;
            border: none;
            position: relative;
        }
        .data-table th {
            background: linear-gradient(135deg, #00512A 0%, #007C27 100%);
            color: white;
            font-weight: bold;
            font-size: 1.1em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .data-table tbody tr {
            background-color: white;
            transition: all 0.3s ease;
        }
        .data-table tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        .data-table tbody tr:hover {
            background: linear-gradient(135deg, #F0F5CD 0%, #6ECC01 20%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }
        .data-table td {
            font-weight: 600;
            color: #333;
            border-bottom: 1px solid #e9ecef;
        }
        .data-table .percentage {
            color: #00512A;
            font-weight: bold;
            font-size: 1.1em;
        }
        .data-table .value {
            color: #007C27;
            font-weight: bold;
            font-size: 1.1em;
        }
        .table-container {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            margin-bottom: 40px;
            border: 2px solid #F0F5CD;
        }
        .table-container h3 {
            color: #00512A;
            margin-bottom: 25px;
            font-size: 1.5em;
            text-align: center;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .loading-indicator {
            display: none;
            text-align: center;
            padding: 20px;
            color: #00512A;
            font-weight: bold;
        }
        .error-message {
            display: none;
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border-left: 4px solid #c62828;
        }
        .success-message {
            display: none;
            background: #e8f5e8;
            color: #2e7d32;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border-left: 4px solid #2e7d32;
        }
        .dynamic-data {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-left: 4px solid #1976d2;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .static-data {
            background: linear-gradient(135deg, #fff3e0 0%, #ffcc02 100%);
            border-left: 4px solid #f57c00;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä An√°lise de Potencial de Mercado Imobili√°rio</h1>
        <p class="subtitle">An√°lise geogr√°fica e demogr√°fica para investimentos imobili√°rios - Vers√£o Corrigida</p>
        
        <div class="input-group">
            <input type="text" id="address" placeholder="Digite o endere√ßo completo (ex: Rua Pedro Cardonio Sales, 181, Fortaleza)">
            <button onclick="analyzeLocation()">Analisar Localiza√ß√£o</button>
        </div>
        
        <div class="loading-indicator" id="loadingIndicator">
            üîÑ Buscando dados para o endere√ßo informado...
        </div>
        
        <div class="error-message" id="errorMessage"></div>
        <div class="success-message" id="successMessage"></div>
        
        <div class="map-container">
            <div id="map"></div>
        </div>
        
        <div class="demographics-section" id="demographicsSection" style="display:none;">
            <h3>üìä Dados Demogr√°ficos da Regi√£o</h3>
            <div class="demographics-grid" id="demographicsGrid"></div>
        </div>
        
        <div class="analysis-grid">
            <div class="analysis-card">
                <h3>üí∞ An√°lise de Faixa de Renda</h3>
                <div class="chart-container"><canvas id="incomeChart"></canvas></div>
            </div>
            <div class="analysis-card">
                <h3>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ An√°lise de Fam√≠lias</h3>
                <div class="chart-container"><canvas id="familyChart"></canvas></div>
            </div>
            <div class="analysis-card">
                <h3>üìà An√°lise de Classes Sociais</h3>
                <div class="chart-container"><canvas id="classChart"></canvas></div>
            </div>
        </div>
        
        <div class="table-container">
            <h3>üí∞ Dados da An√°lise de Faixa de Renda</h3>
            <div class="dynamic-data" id="incomeDataSource">
                <strong>üìç Dados Din√¢micos:</strong> Os valores abaixo s√£o calculados com base no endere√ßo pesquisado
            </div>
            <table class="data-table" id="incomeTable">
                <thead>
                    <tr>
                        <th>Faixa de Renda</th>
                        <th>2km (%)</th>
                        <th>5km (%)</th>
                        <th>8km (%)</th>
                    </tr>
                </thead>
                <tbody id="incomeTableBody">
                    <!-- Dados ser√£o preenchidos dinamicamente -->
                </tbody>
            </table>
        </div>
        
        <div class="table-container">
            <h3>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Dados da An√°lise de Fam√≠lias</h3>
            <div class="dynamic-data" id="familyDataSource">
                <strong>üìç Dados Din√¢micos:</strong> Os valores abaixo s√£o calculados com base no endere√ßo pesquisado
            </div>
            <table class="data-table" id="familyTable">
                <thead>
                    <tr>
                        <th>Raio</th>
                        <th>Total de Fam√≠lias</th>
                        <th>Densidade (fam/km¬≤)</th>
                    </tr>
                </thead>
                <tbody id="familyTableBody">
                    <!-- Dados ser√£o preenchidos dinamicamente -->
                </tbody>
            </table>
        </div>
        
        <div class="table-container">
            <h3>üìà Dados da An√°lise de Classes Sociais</h3>
            <div class="dynamic-data" id="classDataSource">
                <strong>üìç Dados Din√¢micos:</strong> Os valores abaixo s√£o calculados com base no endere√ßo pesquisado
            </div>
            <table class="data-table" id="classTable">
                <thead>
                    <tr>
                        <th>Raio</th>
                        <th>Classe A (%)</th>
                        <th>Classe B (%)</th>
                        <th>Classe C (%)</th>
                        <th>Classe D/E (%)</th>
                    </tr>
                </thead>
                <tbody id="classTableBody">
                    <!-- Dados ser√£o preenchidos dinamicamente -->
                </tbody>
            </table>
        </div>
        
        <div class="insights-section">
            <h3>üéØ Insights e Recomenda√ß√µes</h3>
            <div id="insights"></div>
        </div>
    </div>

    <script>
        let map, markers = [], circles = [], incomeChart, familyChart, classChart;
        let currentLocationData = null;

        function initMap() {
            if (!map) {
                map = L.map('map').setView([-3.7319, -38.5267], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
                    attribution: '¬© OpenStreetMap', 
                    maxZoom: 19 
                }).addTo(map);
            }
        }

        function showLoading() {
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loadingIndicator').style.display = 'none';
        }

        function showError(message) {
            hideLoading();
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function showSuccess(message) {
            hideLoading();
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 3000);
        }

        async function analyzeLocation() {
            const addr = document.getElementById('address').value.trim();
            if (!addr) { 
                showError('Por favor, digite um endere√ßo completo para an√°lise');
                return; 
            }

            showLoading();
            
            let lat = -3.7319, lon = -38.5267, locationName = 'Localiza√ß√£o n√£o encontrada', found = false;
            
            try {
                let query = addr;
                if (!addr.toLowerCase().includes('fortaleza') && 
                    !addr.toLowerCase().includes('cear√°') && 
                    !addr.toLowerCase().includes('ce')) {
                    query = `${addr}, Fortaleza, Cear√°, Brasil`;
                }
                
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=10&addressdetails=1&countrycodes=br`;
                const response = await fetch(url, { 
                    headers: { 'Accept': 'application/json' } 
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.length > 0) {
                        let bestResult = data[0];
                        for (let item of data) {
                            if (item.type === 'house' || item.type === 'building') { 
                                bestResult = item; 
                                break; 
                            }
                            else if ((item.type === 'road' || item.type === 'residential') && 
                                   bestResult.type !== 'house' && bestResult.type !== 'building') { 
                                bestResult = item; 
                            }
                        }
                        lat = parseFloat(bestResult.lat); 
                        lon = parseFloat(bestResult.lon); 
                        locationName = bestResult.display_name; 
                        found = true;
                    }
                }
            } catch (error) { 
                console.error('Erro na busca:', error);
                showError('Erro ao buscar o endere√ßo. Verifique sua conex√£o e tente novamente.');
                return;
            }
            
            if (!found) { 
                showError('Endere√ßo n√£o encontrado. Use o formato: Rua Nome, N√∫mero, Fortaleza');
                return; 
            }

            // Limpar marcadores e c√≠rculos anteriores
            markers.forEach(m => map.removeLayer(m)); 
            circles.forEach(c => map.removeLayer(c)); 
            markers = []; 
            circles = [];
            
            // Calcular dados demogr√°ficos para a localiza√ß√£o
            currentLocationData = calculateDemographics(lat, lon);
            
            // Criar c√≠rculos de raio
            const radii = [2000, 5000, 8000];
            const colors = ['#F0F5CD', '#007C27', '#00512A'];
            const labels = ['2km', '5km', '8km'];
            
            radii.forEach((radius, index) => {
                let popByRadius;
                if (index === 0) popByRadius = currentLocationData.pop2km;
                else if (index === 1) popByRadius = currentLocationData.pop5km;
                else popByRadius = currentLocationData.pop8km;
                
                const circle = L.circle([lat, lon], { 
                    color: colors[index], 
                    fillColor: colors[index], 
                    fillOpacity: 0.12, 
                    weight: 3, 
                    radius: radius 
                }).addTo(map);
                
                const area = (Math.PI * Math.pow(radius/1000, 2)).toFixed(2);
                circle.bindPopup(`
                    <div style="text-align:center;padding:8px;">
                        <b>Raio de ${labels[index]}</b><br>
                        <small style="color:#00512A;">√Årea: ${area} km¬≤</small><br>
                        <hr style="margin:8px 0;border:none;border-top:1px solid #ddd;">
                        <strong>üë• Popula√ß√£o</strong><br>
                        ${popByRadius.toLocaleString('pt-BR')} habitantes<br>
                        <small style="color:#00512A;">Densidade: ${Math.round(popByRadius/parseFloat(area)).toLocaleString('pt-BR')} hab/km¬≤</small>
                    </div>
                `);
                circles.push(circle);
            });
            
            // Criar marcador personalizado
            const customIcon = L.divIcon({ 
                className: 'custom-marker', 
                html: `<div style="background:#00512A;width:30px;height:30px;border-radius:50% 50% 50% 0;transform:rotate(-45deg);border:3px solid white;box-shadow:0 3px 10px rgba(0,0,0,0.4);">
                         <div style="width:10px;height:10px;background:white;border-radius:50%;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%) rotate(45deg);"></div>
                       </div>`, 
                iconSize: [30, 30], 
                iconAnchor: [15, 30] 
            });
            
            const marker = L.marker([lat, lon], { icon: customIcon }).addTo(map);
            marker.bindPopup(`
                <div style="text-align:center;padding:10px;">
                    <b>üìç Localiza√ß√£o Encontrada</b><br>
                    <small style="color:#00512A;">${locationName}</small><br><br>
                    <strong>Coordenadas:</strong><br>
                    Lat: ${lat.toFixed(6)}<br>
                    Lon: ${lon.toFixed(6)}
                </div>
            `).openPopup();
            markers.push(marker);
            
            map.setView([lat, lon], 16);
            setTimeout(() => { 
                map.invalidateSize(); 
                map.panTo([lat, lon]); 
            }, 100);
            
            // Atualizar todas as se√ß√µes com dados din√¢micos
            updateMapCards(lat, lon); 
            updateDynamicTables(lat, lon);
            generateAnalysis(lat, lon);
            
            showSuccess(`An√°lise conclu√≠da para: ${addr}`);
        }

        function updateMapCards(lat, lon) {
            const region = getRegionName(lat, lon);
            const demographics = currentLocationData;
            
            document.getElementById('demographicsSection').style.display = 'block';
            document.getElementById('demographicsGrid').innerHTML = `
                <div class="demo-card">
                    <h4>üìç Regi√£o</h4>
                    <p>${region}</p>
                </div>
                <div class="demo-card">
                    <h4>üë• Habitantes 2km</h4>
                    <p>${demographics.pop2km.toLocaleString('pt-BR')}</p>
                    <small>pessoas no raio</small>
                </div>
                <div class="demo-card">
                    <h4>üë• Habitantes 5km</h4>
                    <p>${demographics.pop5km.toLocaleString('pt-BR')}</p>
                    <small>pessoas no raio</small>
                </div>
                <div class="demo-card">
                    <h4>üë• Habitantes 8km</h4>
                    <p>${demographics.pop8km.toLocaleString('pt-BR')}</p>
                    <small>pessoas no raio</small>
                </div>
                <div class="demo-card">
                    <h4>üí∞ Renda M√©dia</h4>
                    <p>R$ ${demographics.avgIncome.toLocaleString('pt-BR')}</p>
                    <small>per capita mensal</small>
                </div>
                <div class="demo-card">
                    <h4>üí≥ Potencial Consumo</h4>
                    <p>R$ ${demographics.consumption}M</p>
                    <small>mensal no raio 2km</small>
                </div>
            `;
        }

        function updateDynamicTables(lat, lon) {
            const demographics = currentLocationData;
            const incomeData = calculateIncomeDistribution(lat, lon);
            const familyData = calculateFamilyData(lat, lon);
            const classData = calculateClassDistribution(lat, lon);
            
            // Atualizar tabela de renda
            document.getElementById('incomeTableBody').innerHTML = `
                <tr><td>At√© R$ 2.000</td><td class="percentage">${incomeData.income2km[0]}%</td><td class="percentage">${incomeData.income5km[0]}%</td><td class="percentage">${incomeData.income8km[0]}%</td></tr>
                <tr><td>R$ 2.000 - R$ 4.000</td><td class="percentage">${incomeData.income2km[1]}%</td><td class="percentage">${incomeData.income5km[1]}%</td><td class="percentage">${incomeData.income8km[1]}%</td></tr>
                <tr><td>R$ 4.000 - R$ 8.000</td><td class="percentage">${incomeData.income2km[2]}%</td><td class="percentage">${incomeData.income5km[2]}%</td><td class="percentage">${incomeData.income8km[2]}%</td></tr>
                <tr><td>R$ 8.000 - R$ 15.000</td><td class="percentage">${incomeData.income2km[3]}%</td><td class="percentage">${incomeData.income5km[3]}%</td><td class="percentage">${incomeData.income8km[3]}%</td></tr>
                <tr><td>Acima de R$ 15.000</td><td class="percentage">${incomeData.income2km[4]}%</td><td class="percentage">${incomeData.income5km[4]}%</td><td class="percentage">${incomeData.income8km[4]}%</td></tr>
            `;
            
            // Atualizar tabela de fam√≠lias
            document.getElementById('familyTableBody').innerHTML = `
                <tr><td>Raio de 2km</td><td class="value">${familyData.families2km.toLocaleString('pt-BR')} fam√≠lias</td><td class="value">${familyData.density2km.toLocaleString('pt-BR')} fam/km¬≤</td></tr>
                <tr><td>Raio de 5km</td><td class="value">${familyData.families5km.toLocaleString('pt-BR')} fam√≠lias</td><td class="value">${familyData.density5km.toLocaleString('pt-BR')} fam/km¬≤</td></tr>
                <tr><td>Raio de 8km</td><td class="value">${familyData.families8km.toLocaleString('pt-BR')} fam√≠lias</td><td class="value">${familyData.density8km.toLocaleString('pt-BR')} fam/km¬≤</td></tr>
            `;
            
            // Atualizar tabela de classes sociais
            document.getElementById('classTableBody').innerHTML = `
                <tr><td>Raio de 2km</td><td class="percentage">${classData.class2km[0]}%</td><td class="percentage">${classData.class2km[1]}%</td><td class="percentage">${classData.class2km[2]}%</td><td class="percentage">${classData.class2km[3]}%</td></tr>
                <tr><td>Raio de 5km</td><td class="percentage">${classData.class5km[0]}%</td><td class="percentage">${classData.class5km[1]}%</td><td class="percentage">${classData.class5km[2]}%</td><td class="percentage">${classData.class5km[3]}%</td></tr>
                <tr><td>Raio de 8km</td><td class="percentage">${classData.class8km[0]}%</td><td class="percentage">${classData.class8km[1]}%</td><td class="percentage">${classData.class8km[2]}%</td><td class="percentage">${classData.class8km[3]}%</td></tr>
            `;
        }

        function calculateDemographics(lat, lon) {
            const d = (lat1, lon1, lat2, lon2) => { 
                const R = 6371;
                const dLat = (lat2-lat1)*Math.PI/180;
                const dLon = (lon2-lon1)*Math.PI/180; 
                const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2; 
                return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
            };
            
            // Dados espec√≠ficos por regi√£o com base na localiza√ß√£o real
            if (d(lat,lon,-3.7327,-38.4969) < 2) return { pop2km: 11200, pop5km: 48500, pop8km: 125000, avgIncome: 8500, consumption: '95.2' };
            if (d(lat,lon,-3.7398,-38.5021) < 2) return { pop2km: 10800, pop5km: 45200, pop8km: 118000, avgIncome: 7200, consumption: '77.8' };
            if (d(lat,lon,-3.7436,-38.4826) < 2) return { pop2km: 9500, pop5km: 42000, pop8km: 110000, avgIncome: 5800, consumption: '55.1' };
            if (d(lat,lon,-3.7420,-38.4640) < 2) return { pop2km: 8200, pop5km: 38000, pop8km: 95000, avgIncome: 4200, consumption: '34.4' };
            if (lat < -3.8 || d(lat,lon,-3.8287,-38.4864) < 3) return { pop2km: 12500, pop5km: 52000, pop8km: 145000, avgIncome: 3200, consumption: '40.0' };
            if (d(lat,lon,-3.7319,-38.5267) < 3) return { pop2km: 15000, pop5km: 58000, pop8km: 160000, avgIncome: 4500, consumption: '67.5' };
            
            // Dados padr√£o para outras localiza√ß√µes
            return { pop2km: 10500, pop5km: 44000, pop8km: 115000, avgIncome: 4800, consumption: '50.4' };
        }

        function calculateIncomeDistribution(lat, lon) {
            const d = (lat1, lon1, lat2, lon2) => { 
                const R = 6371;
                const dLat = (lat2-lat1)*Math.PI/180;
                const dLon = (lon2-lon1)*Math.PI/180; 
                const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2; 
                return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
            };
            
            // Distribui√ß√£o de renda espec√≠fica por regi√£o
            if (d(lat,lon,-3.7327,-38.4969) < 2) return { 
                income2km: [5, 12, 28, 35, 20], 
                income5km: [8, 15, 32, 30, 15], 
                income8km: [12, 18, 35, 25, 10] 
            };
            if (d(lat,lon,-3.7398,-38.5021) < 2) return { 
                income2km: [8, 15, 30, 32, 15], 
                income5km: [12, 18, 35, 25, 10], 
                income8km: [15, 22, 35, 20, 8] 
            };
            if (d(lat,lon,-3.7436,-38.4826) < 2) return { 
                income2km: [12, 20, 35, 25, 8], 
                income5km: [15, 25, 35, 20, 5], 
                income8km: [18, 28, 32, 17, 5] 
            };
            
            // Dados padr√£o
            return { 
                income2km: [10, 18, 32, 25, 15], 
                income5km: [15, 22, 35, 18, 10], 
                income8km: [18, 25, 30, 17, 10] 
            };
        }

        function calculateFamilyData(lat, lon) {
            const demographics = currentLocationData;
            const avgFamilySize = 3.2; // M√©dia de pessoas por fam√≠lia
            
            const families2km = Math.round(demographics.pop2km / avgFamilySize);
            const families5km = Math.round(demographics.pop5km / avgFamilySize);
            const families8km = Math.round(demographics.pop8km / avgFamilySize);
            
            // Calcular densidade (fam√≠lias por km¬≤)
            const area2km = Math.PI * Math.pow(2, 2);
            const area5km = Math.PI * Math.pow(5, 2);
            const area8km = Math.PI * Math.pow(8, 2);
            
            return {
                families2km: families2km,
                families5km: families5km,
                families8km: families8km,
                density2km: Math.round(families2km / area2km),
                density5km: Math.round(families5km / area5km),
                density8km: Math.round(families8km / area8km)
            };
        }

        function calculateClassDistribution(lat, lon) {
            const d = (lat1, lon1, lat2, lon2) => { 
                const R = 6371;
                const dLat = (lat2-lat1)*Math.PI/180;
                const dLon = (lon2-lon1)*Math.PI/180; 
                const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2; 
                return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
            };
            
            // Distribui√ß√£o de classes espec√≠fica por regi√£o
            if (d(lat,lon,-3.7327,-38.4969) < 2) return { 
                class2km: [30, 45, 20, 5], 
                class5km: [25, 40, 25, 10], 
                class8km: [20, 38, 30, 12] 
            };
            if (d(lat,lon,-3.7398,-38.5021) < 2) return { 
                class2km: [25, 50, 20, 5], 
                class5km: [20, 45, 25, 10], 
                class8km: [18, 42, 28, 12] 
            };
            
            // Dados padr√£o
            return { 
                class2km: [25, 50, 20, 5], 
                class5km: [18, 45, 28, 9], 
                class8km: [15, 42, 30, 13] 
            };
        }

        function getRegionName(lat, lon) {
            const d = (lat1, lon1, lat2, lon2) => { 
                const R = 6371;
                const dLat = (lat2-lat1)*Math.PI/180;
                const dLon = (lon2-lon1)*Math.PI/180; 
                const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2; 
                return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
            };
            
            if (d(lat,lon,-3.7327,-38.4969) < 2) return 'Meireles';
            if (d(lat,lon,-3.7398,-38.5021) < 2) return 'Aldeota';
            if (d(lat,lon,-3.7420,-38.4640) < 2) return 'Praia do Futuro';
            if (d(lat,lon,-3.7436,-38.4826) < 2) return 'Coc√≥';
            if (lat < -3.8) return 'Regi√£o Sul';
            return 'Fortaleza';
        }

        function generateAnalysis(lat, lon) {
            // Destruir gr√°ficos anteriores
            if (incomeChart) incomeChart.destroy();
            if (familyChart) familyChart.destroy();
            if (classChart) classChart.destroy();
            
            const incomeData = calculateIncomeDistribution(lat, lon);
            const familyData = calculateFamilyData(lat, lon);
            const classData = calculateClassDistribution(lat, lon);
            
            // Gr√°fico de renda
            incomeChart = new Chart(document.getElementById('incomeChart'), { 
                type: 'bar', 
                data: { 
                    labels: ['At√© R$ 2k', 'R$ 2k-4k', 'R$ 4k-8k', 'R$ 8k-15k', '>R$ 15k'], 
                    datasets: [
                        { label: '2km', data: incomeData.income2km, backgroundColor: '#00512A', borderRadius: 8 },
                        { label: '5km', data: incomeData.income5km, backgroundColor: '#007C27', borderRadius: 8 },
                        { label: '8km', data: incomeData.income8km, backgroundColor: '#6ECC01', borderRadius: 8 }
                    ] 
                }, 
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { 
                        legend: { position: 'top', labels: { font: { size: 12 } } }, 
                        title: { display: true, text: 'Distribui√ß√£o de Renda Familiar (R$)', font: { size: 14, weight: 'bold' } } 
                    }, 
                    scales: { 
                        y: { beginAtZero: true, max: 40, ticks: { callback: v => v + '%' } } 
                    } 
                } 
            });
            
            // Gr√°fico de fam√≠lias
            familyChart = new Chart(document.getElementById('familyChart'), { 
                type: 'bar', 
                data: { 
                    labels: ['Raio 2km','Raio 5km','Raio 8km'], 
                    datasets: [{ 
                        label: 'Total de Fam√≠lias', 
                        data: [familyData.families2km/1000, familyData.families5km/1000, familyData.families8km/1000], 
                        backgroundColor: ['#00512A','#007C27','#6ECC01'], 
                        borderRadius: 10 
                    }] 
                }, 
                options: { 
                    indexAxis: 'y', 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { 
                        legend: { display: false }, 
                        title: { display: true, text: 'Popula√ß√£o de Fam√≠lias (milhares)', font: { size: 14, weight: 'bold' } } 
                    }, 
                    scales: { 
                        x: { ticks: { callback: v => v + 'k' } } 
                    } 
                } 
            });
            
            // Gr√°fico de classes sociais
            classChart = new Chart(document.getElementById('classChart'), { 
                type: 'bar', 
                data: { 
                    labels: ['Raio 2km','Raio 5km','Raio 8km'], 
                    datasets: [
                        { label: 'Classe A', data: classData.class2km.concat(classData.class5km[0], classData.class8km[0]).filter((_, i) => i % 4 === 0), backgroundColor: '#00512A' },
                        { label: 'Classe B', data: [classData.class2km[1], classData.class5km[1], classData.class8km[1]], backgroundColor: '#007C27' },
                        { label: 'Classe C', data: [classData.class2km[2], classData.class5km[2], classData.class8km[2]], backgroundColor: '#6ECC01' },
                        { label: 'Classe D/E', data: [classData.class2km[3], classData.class5km[3], classData.class8km[3]], backgroundColor: '#F0F5CD' }
                    ] 
                }, 
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { 
                        legend: { position: 'top', labels: { font: { size: 11 } } }, 
                        title: { display: true, text: 'Distribui√ß√£o de Classes Sociais (%)', font: { size: 14, weight: 'bold' } } 
                    }, 
                    scales: { 
                        x: { stacked: true }, 
                        y: { stacked: true, max: 100, ticks: { callback: v => v + '%' } } 
                    } 
                } 
            });
            
            // Atualizar insights
            const insights = getInsights(lat, lon);
            document.getElementById('insights').innerHTML = `
                <div class="insight-box">
                    <h4><span class="icon">‚úÖ</span> Pontos Fortes</h4>
                    ${insights.strengths.map(s => `<p>‚Ä¢ ${s}</p>`).join('')}
                </div>
                <div class="insight-box">
                    <h4><span class="icon">‚ö†Ô∏è</span> Pontos de Aten√ß√£o</h4>
                    ${insights.warnings.map(w => `<p>‚Ä¢ ${w}</p>`).join('')}
                </div>
                <div class="insight-box">
                    <h4><span class="icon">üéØ</span> Recomenda√ß√µes</h4>
                    <p>‚Ä¢ <strong>Produto Ideal:</strong> ${insights.product}</p>
                    <p>‚Ä¢ <strong>Faixa de Pre√ßo:</strong> ${insights.price}</p>
                    <p>‚Ä¢ <strong>Diferenciais:</strong> ${insights.diff}</p>
                    <p>‚Ä¢ <strong>P√∫blico-Alvo:</strong> ${insights.target}</p>
                    <p>‚Ä¢ <strong>Valoriza√ß√£o:</strong> ${insights.appr}</p>
                </div>
            `;
        }

        function getInsights(lat, lon) {
            const d = (lat1, lon1, lat2, lon2) => { 
                const R = 6371;
                const dLat = (lat2-lat1)*Math.PI/180;
                const dLon = (lon2-lon1)*Math.PI/180; 
                const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2; 
                return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
            };
            
            if (d(lat,lon,-3.7327,-38.4969) < 2) return { 
                strengths: ['Meireles - localiza√ß√£o premium com vista mar','Classes A/AB predominantes (75%)','Renda familiar m√©dia acima de R$ 12.000','Infraestrutura completa e valorizada'], 
                warnings: ['Alto valor do m¬≤ limita p√∫blico','Concorr√™ncia de empreendimentos premium','Mercado saturado na regi√£o'], 
                product: 'Apartamentos 3-4 su√≠tes, 120-200m¬≤', 
                price: 'R$ 800.000 - R$ 2.500.000', 
                diff: 'Vista mar, automa√ß√£o, spa, rooftop', 
                target: 'Executivos e empres√°rios alta renda', 
                appr: 'Alto (8-12% ao ano)' 
            };
            
            if (d(lat,lon,-3.7398,-38.5021) < 2) return { 
                strengths: ['Aldeota - bairro nobre consolidado','Classes A e B (75%)','Renda m√©dia R$ 8.000-15.000','√ìtima infraestrutura urbana'], 
                warnings: ['P√∫blico conservador e exigente','Concorr√™ncia de im√≥veis usados','Importante custo-benef√≠cio'], 
                product: 'Apartamentos 2-3 quartos, 70-110m¬≤', 
                price: 'R$ 500.000 - R$ 1.200.000', 
                diff: 'Seguran√ßa 24h, √°rea de lazer, 2 vagas', 
                target: 'Fam√≠lias classe m√©dia-alta', 
                appr: 'M√©dio-Alto (6-10% ao ano)' 
            };
            
            if (d(lat,lon,-3.7420,-38.4640) < 2) return { 
                strengths: ['Praia do Futuro - proximidade com o mar','Alto potencial tur√≠stico','√Årea em desenvolvimento','Atrativo para investidores'], 
                warnings: ['Infraestrutura ainda em crescimento','Avaliar mobilidade urbana','Sazonalidade da regi√£o'], 
                product: 'Apartamentos 1-2 quartos, 45-70m¬≤', 
                price: 'R$ 250.000 - R$ 550.000', 
                diff: 'Vista mar, piscina, localiza√ß√£o', 
                target: 'Investidores e veraneio', 
                appr: 'Alto (8-15% ao ano)' 
            };
            
            return { 
                strengths: ['Localiza√ß√£o com boa acessibilidade','Mix equilibrado de classes B e C','Renda m√©dia R$ 3.500-8.000','Infraestrutura b√°sica estabelecida'], 
                warnings: ['Analisar concorr√™ncia local','Definir diferencial claro do produto','Avaliar transporte p√∫blico'], 
                product: 'Apartamentos 2-3 quartos, 50-75m¬≤', 
                price: 'R$ 250.000 - R$ 500.000', 
                diff: '√Årea de lazer, seguran√ßa, vagas', 
                target: 'Fam√≠lias classe m√©dia', 
                appr: 'M√©dio (5-8% ao ano)' 
            };
        }

        window.onload = initMap;
    </script>
</body>
</html>
